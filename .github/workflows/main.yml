name: RDP greenboyMC - Intro The Flash (Giảm Lag FULL MAX 2026)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Download & Extract Ngrok
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .

      - name: Auth Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: .\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN

      - name: Giảm Lag FULL MAX + Fast Intro + TurboRemoteFX
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

          # User greenboyMC
          New-LocalUser "greenboyMC" -Password (ConvertTo-SecureString -AsPlainText "W1nd0ws-P4ssw0rd-2025!" -Force) -FullName "greenboyMC"
          Add-LocalGroupMember -Group "Administrators" -Member "greenboyMC"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "greenboyMC"

          # Intro flash siêu nhanh + tắt hết visual (BetterRDP style)
          reg add "HKCU\Control Panel\Desktop" /v UserPreferencesMask /t REG_BINARY /d 9012038010000000 /f
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 3 /f
          reg add "HKCU\Control Panel\Desktop\WindowMetrics" /v MinAnimate /t REG_SZ /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v TaskbarAnimations /t REG_DWORD /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v EnableTransparency /t REG_DWORD /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\DWM" /v EnableAeroPeek /t REG_DWORD /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\DWM" /v AnimationsShiftKey /t REG_DWORD /d 0 /f

          # Tắt service nặng full + telemetry
          @("SysMain","WSearch","DiagTrack","wuauserv","bits","WindowsSearch","WinDefend","Themes") | ForEach-Object {
            Stop-Service -Name $_ -Force -ErrorAction SilentlyContinue
            Set-Service -Name $_ -StartupType Disabled -ErrorAction SilentlyContinue
          }

          # Power plan High Performance
          powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

          # RDP FULL MAX LOW LATENCY (TurboRemoteFX + BetterRDP + NVIDIA tweaks)
          New-Item -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Force | Out-Null
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxCompressionLevel" -Value 0 -Type DWord  # No compression
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "AVCHardwareEncodePreferred" -Value 1 -Type DWord
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "AVC444ModePreferred" -Value 1 -Type DWord
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fEnableRemoteFX" -Value 1 -Type DWord
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "CompressionAlgorithm" -Value 0 -Type DWord  # No RDP compression
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxFrameRate" -Value 60 -Type DWord  # 60 FPS unlock
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations' -Name "DWMFRAMEINTERVAL" -Value 10 -Type DWord  # Low latency DWM
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "InteractiveDelay" -Value 0 -Type DWord  # Zero interactive delay
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\TermDD' -Name "FlowControlDisable" -Value 1 -Type DWord  # Disable flow control

          # NVIDIA RmWatchDogInterval low latency (nếu có GPU NVIDIA)
          $gpuKey = Get-ChildItem 'HKLM:\SYSTEM\CurrentControlSet\Control\Class\{4d36e968-e325-11ce-bfc1-08002be10318}' | Where-Object { $_.GetValue('DriverDesc') -like '*NVIDIA*' } | Select-Object -First 1
          if ($gpuKey) {
            $gpuPath = $gpuKey.PSChildName
            reg add "HKLM\SYSTEM\CurrentControlSet\Control\Class\{4d36e968-e325-11ce-bfc1-08002be10318}\$gpuPath" /v RmWatchDogInterval /t REG_DWORD /d 0x2710 /f
          }

      - name: Start Ngrok Asia & Hiện IP Siêu Nhanh
        run: |
          Write-Host "=================================================="
          Write-Host "RDP greenboyMC - LAG GIẢM FULL MAX 2026!"
          Write
